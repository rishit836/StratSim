{% extends "layout.html" %}
{% load static %}
{% load custom_filters %}
{% block pagename %}Home{% endblock pagename %}
{% block header %} 
<link rel="stylesheet" href='{% static "mainapp/styles/homepage.css" %}'>
{% endblock header %}


{% block body %}
<div class="dashboard-outer">


    {% if messages %}

{% for message in messages %}
    <div id="snackbar">
        {{message}}
    </div>
{% endfor %}
<script>
    var x = document.getElementById("snackbar");
    x.className = "show";

    setTimeout(function(){x.className=x.className.replace("show","");},6000)
</script>
    {% endif %}


    
  <div class="dashboard-container{% if not request.user.is_authenticated %} blurred{% endif %}">
    <div class="heading-container">
      <div>
        {% if request.user.is_authenticated %}
        <h4 class="heading greet">Welcome
            <span style="text-decoration: underline;">{{request.user}}</span>,
            </h4>
        {% endif %}
        <h3 class="heading">Dashboard</h3>
        <div class="dashboard-subtext">Overview of your portfolio and recent activity.</div>
      </div>
    </div>
    <div class="overview-cards">
      <div class="dashboard-card">
        <div class="card-title">Total Virtual Funds</div>
        <div class="card-value">${{fund}}</div>
        <div class="card-change {{fv}}">
            {% if fv == "positive" %}
                +
            {% endif %}
            {{fc|round_:2}}%</div>
    </div>
    <div class="dashboard-card">
        <div class="card-title">Investment:</div>
        <div class="card-value">$ {{invested_funds|round_:2}}</div>
        <div class="card-change"><a href="{% url 'main:portfolio' %}">view investments</a></div>
    </div>
    <div class="dashboard-card">
        <div class="card-title">Active Strategies</div>
        <div class="card-value">{{active_strats}}</div>
        <div class="card-change {{sv}}">
            {% if sv == "positive" %}
                +
            {% endif %}
            {{strat_change|round_:2}}%</div>
    </div>
    </div>
    <div class="portfolio-container">
      <div class="heading-container">
        <div>
          <h4 class="heading">Perfomance</h4>
          <div class="dashboard-subtext">Portfolio Chart</div>
          {% if holdings_available %}
            <div class="dashboard-chart">

            </div>
          {% endif %}
{% if history_available %}
<div class="fund-chart">
  <canvas id="fundChart" ></canvas>
</div>
  <!-- JSON-encoded fund_data -->
  {{ fund_data|json_script:"fundData" }}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ✅ Canvas -->


<!-- ✅ fund_data JSON safely rendered -->
{{ fund_data|json_script:"fundData" }}

<!-- ✅ JavaScript block -->
<script>
  const ctx = document.getElementById('fundChart').getContext('2d');
  const data = JSON.parse(document.getElementById('fundData').textContent);

  console.log("Loaded fund data:", data);  // ✅ Should log object with labels & values

  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(144, 238, 144, 0.5)');
  gradient.addColorStop(1, 'rgba(144, 238, 144, 0.05)');

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'Fund History',
        data: data.values,
        borderColor: 'lightgreen',
        backgroundColor: gradient,
        fill: true,
        tension: .5,
        pointRadius: 0,
      }]
    },
    options: {
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          ticks: {
            color: '#a0a0a0',
            font: { size: 10 },
            maxRotation: 0,
            autoSkip: true,
            maxTicksLimit: 7,
          },
          grid: { display: false }
        },
       
      }
    }
  });
</script>
  {% endif %}
  

          


        </div>
      </div>
    </div>
  </div>
  {% if not request.user.is_authenticated %}
  <div class="dashboard-blur-overlay">
    <span>Log in to view dashboard</span>
  </div>
  {% endif %}
</div>
{% endblock body %}
